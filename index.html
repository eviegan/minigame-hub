<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mini Game Hub</title>
<style>
  :root { color-scheme: dark; }
  html,body{height:100%;margin:0;background:#090a16;color:#eef4ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  canvas{display:block;width:100%;height:100%}
  #menu,#leaderboardOverlay{position:fixed;inset:0;display:none;place-items:center;z-index:5;background:linear-gradient(180deg,#0a0718 0%, #090a16 100%)}
  .card{width:min(560px,92%);background:#0f1226;border:1px solid #243;border-radius:16px;padding:20px;box-shadow:0 20px 60px #0007;text-align:center}
  .grid{display:grid;gap:12px;margin-top:14px}
  .primary{background:#8a5dff;color:#0a0718;font-weight:800;border:0;padding:12px 16px;border-radius:14px;cursor:pointer;font-size:18px}
  .ghost{background:#1b2040;color:#cfe1ff;border:1px solid #2b325d;padding:10px 14px;border-radius:10px;cursor:pointer;font-size:16px}
  #hud{position:fixed;right:12px;bottom:12px;background:#0008;backdrop-filter:blur(8px);padding:8px 12px;border-radius:12px;z-index:4}
  #hud button{border:0;border-radius:12px;padding:8px 12px;font-weight:700;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px 10px;border-bottom:1px solid #2b325d;text-align:left}
  .muted{color:#a9b7d8}
  .comboChip{position:fixed;left:50%;top:68px;transform:translateX(-50%);background:#1b2040;border:1px solid #2b325d;border-radius:999px;padding:6px 12px;font-weight:800;letter-spacing:.4px;display:none;z-index:6}
</style>
<script src="https://cdn.jsdelivr.net/npm/phaser@3.90.0/dist/phaser.min.js"></script>
</head>
<body>
  <div id="hud"><button id="claim">Claim reward</button></div>
  <div id="combo" class="comboChip">Combo √ó2</div>

  <!-- Menu -->
  <div id="menu">
    <div class="card">
      <h1 style="margin:0 0 6px">Mini Game Hub</h1>
      <p class="muted" style="margin:0 0 16px">Pick a game. Press <b>ESC</b> to return here.</p>
      <div class="grid">
        <button class="primary" data-mode="mole">üéØ Whack-a-Mole</button>
        <button class="primary" data-mode="catch">üß∫ Catch the Coins</button>
        <button class="primary" data-mode="wheel">üé° Spin the Wheel (3/day)</button>
        <button class="ghost" id="openLeaderboard">üèÜ Leaderboard</button>
      </div>
    </div>
  </div>

  <!-- Leaderboard -->
  <div id="leaderboardOverlay">
    <div class="card">
      <h2 style="margin:0 0 6px">üèÜ Leaderboard</h2>
      <p class="muted" style="margin:0 0 10px">Top 5 per game (saved on your device)</p>
      <div class="grid" id="lbTabs" style="grid-template-columns:repeat(4,1fr)">
        <button class="ghost" data-lb="mole">Mole</button>
        <button class="ghost" data-lb="catch">Catch</button>
        <button class="ghost" data-lb="wheel">Wheel</button>
        <button class="ghost" data-lb="all">All</button>
      </div>
      <div id="lbTables" style="margin-top:10px;text-align:left"></div>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:14px">
        <button class="ghost" id="clearLB">Clear my scores</button>
        <button class="primary" id="closeLB">Close</button>
      </div>
    </div>
  </div>

<script>
/* ------------------------ tiny sound engine (WebAudio) ------------------------ */
const Sound = (() => {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const resume = () => ctx.state === 'suspended' && ctx.resume();
  window.addEventListener('pointerdown', resume, { once:true });

  function tone(freq=440, dur=0.12, type='sine', vol=0.18) {
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type=type; o.frequency.value=freq; o.connect(g); g.connect(ctx.destination);
    const t=ctx.currentTime; g.gain.setValueAtTime(0,t);
    g.gain.linearRampToValueAtTime(vol,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
    o.start(t); o.stop(t+dur+0.02);
  }
  function chord(freqs=[660,880,1320], dur=0.14, type='sine', vol=0.14) {
    freqs.forEach((f,i)=>tone(f, dur*(1-0.12*i), type, vol));
  }
  function pop(){ tone(1200,0.08,'triangle',0.16); }
  function click(){ tone(880,0.05,'square',0.1); }
  function ding(){ chord([660,990,1320],0.16,'sine',0.16); }
  function boom(){
    const len=ctx.sampleRate*0.22, buf=ctx.createBuffer(1,len,ctx.sampleRate);
    const data=buf.getChannelData(0); for(let i=0;i<len;i++){ data[i]=(Math.random()*2-1)*(1-i/len); }
    const src=ctx.createBufferSource(); src.buffer=buf;
    const g=ctx.createGain(); g.gain.value=0.35; src.connect(g); g.connect(ctx.destination); src.start();
    tone(90,0.2,'sine',0.12);
  }
  return { pop, click, ding, boom };
})();

/* ------------------------ shared utils ------------------------ */
const W=()=>innerWidth, H=()=>innerHeight;
const SETTINGS={
  rewardThreshold:{ mole:10, catch:12 },
  mole:{ duration:25, gridSmall:3, gridLarge:4, popEvery:650, upTime:800 }, // s / grid / ms
  wheelDailyLimit:3
};
const todayKey=()=>new Date().toISOString().slice(0,10);

function toast(scene,msg){
  const t=scene.add.text(scene.scale.width/2,scene.scale.height*.85,msg,
    {fontSize:'22px',color:'#fff',backgroundColor:'#0008',padding:{x:12,y:8}}).setOrigin(.5);
  scene.tweens.add({targets:t,alpha:0,duration:1200,delay:800,onComplete:()=>t.destroy()});
}
function saveScore(game,value){
  try{
    const key=`lb_${game}`; const list=JSON.parse(localStorage.getItem(key)||"[]");
    list.push({score:value,ts:Date.now()}); list.sort((a,b)=>b.score-a.score);
    localStorage.setItem(key,JSON.stringify(list.slice(0,5)));
  }catch(e){}
}
const getScores=(g)=>{try{return JSON.parse(localStorage.getItem(`lb_${g}`)||"[]")}catch(e){return[]}};
const incSpinCount=()=>localStorage.setItem(`wheel_${todayKey()}`,((+localStorage.getItem(`wheel_${todayKey()}`)||0)+1).toString());
const getSpinCount=()=>+localStorage.getItem(`wheel_${todayKey()}`)||0;

function makeRectTexture(scene,key,w,h,fill,stroke=0xffffff){
  if(scene.textures.exists(key))return;
  const g=scene.add.graphics(); g.fillStyle(fill,1).fillRoundedRect(0,0,w,h,6);
  g.lineStyle(2,stroke,1).strokeRoundedRect(0,0,w,h,6); g.generateTexture(key,w,h); g.destroy();
}
function makeEmojiTexture(scene,key,emoji,size=48){
  if(scene.textures.exists(key))return;
  const c=document.createElement('canvas'); c.width=c.height=size;
  const ctx=c.getContext('2d'); ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.font=`${Math.floor(size*0.9)}px "Apple Color Emoji","Segoe UI Emoji",sans-serif`;
  ctx.fillText(emoji,size/2,size/2);
  scene.textures.addImage(key,c);
}

/* ---------- UI combo chip ---------- */
const comboChip = document.getElementById('combo');
function showCombo(mult){
  comboChip.textContent = `Combo √ó${mult}`;
  comboChip.style.display='block';
  comboChip.animate([{transform:'translate(-50%,-4px)'},{transform:'translate(-50%,0)'}],{duration:120});
}
function hideCombo(){ comboChip.style.display='none'; }

/* ------------------------ Whack-a-Mole (animals + bomb + combo) ------------------------ */
class MoleScene extends Phaser.Scene{
  constructor(){ super('mole'); this.score=0; this.timeLeft=SETTINGS.mole.duration; this.rewarded=false; this.holes=[]; this.combo=0; this.comboTimer=null; }
  create(){
    const {width,height}=this.scale;
    this.cameras.main.setBackgroundColor('#0a0718');
    this.add.text(width/2,28,'üéØ Whack-a-Mole',{fontSize:'24px',color:'#fff'}).setOrigin(.5);
    this.scoreText=this.add.text(20,16,'Score: 0',{fontSize:'20px',color:'#8EFF98'});
    this.timerText=this.add.text(width-20,16,this.timeLeft+'s',{fontSize:'20px',color:'#ffd86a'}).setOrigin(1,0);

    // textures
    makeEmojiTexture(this,'emoji_hamster','üêπ',64);
    makeEmojiTexture(this,'emoji_cat','üê±',64);
    makeEmojiTexture(this,'emoji_dog','üê∂',64);
    makeEmojiTexture(this,'emoji_rabbit','üê∞',64);
    makeEmojiTexture(this,'emoji_bomb','üí£',64);
    makeRectTexture(this,'holePlate',96,28,0x1b2040,0x2b325d);

    // grid
    const cols=(Math.min(width,height)<720)?SETTINGS.mole.gridSmall:SETTINGS.mole.gridLarge;
    const rows=cols;
    const gridW=Math.min(width*0.9,height*0.78);
    const cell=gridW/cols, startX=width/2-gridW/2+cell/2, startY=height*0.2+cell/2;

    const animals=['emoji_hamster','emoji_cat','emoji_dog','emoji_rabbit'];

    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        const x=startX+c*cell, y=startY+r*cell;
        const plate=this.add.image(x,y+20,'holePlate');
        const face=this.add.image(x,y,'emoji_hamster').setVisible(false).setInteractive({useHandCursor:true});

        face.on('pointerdown',()=>{
          if(!face.visible)return;
          if(face.getData('type')==='bomb'){
            // bomb: -2, shake, boom, reset combo
            this.cameras.main.shake(120,0.003); Sound.boom();
            this.score=Math.max(0,this.score-2); this.resetCombo(); hideCombo();
          }else{
            // animal: +1 * multiplier, pop, combo++
            const mult = this.bumpCombo(); // returns 1,2,3
            Sound.pop();
            this.score += 1*mult;
            showCombo(mult);
          }
          this.scoreText.setText('Score: '+this.score);
          this.tweens.add({targets:face, y:face.y-12, duration:90, yoyo:true, onComplete:()=>face.setVisible(false)});
          if(!this.rewarded && this.score>=SETTINGS.rewardThreshold.mole){ this.rewarded=true; toast(this,'üéâ Reward unlocked!'); }
        });

        this.holes.push({plate,face});
      }
    }

    // pop logic
    this.popEvt=this.time.addEvent({ delay:SETTINGS.mole.popEvery, loop:true, callback:()=>{
      const free=this.holes.filter(h=>!h.face.visible);
      if(!free.length)return;
      const h=Phaser.Utils.Array.GetRandom(free);

      const isBomb=Math.random()<0.18;
      const tex=isBomb ? 'emoji_bomb' : Phaser.Utils.Array.GetRandom(animals);
      h.face.setTexture(tex).setData('type', isBomb ? 'bomb' : 'animal');
      h.face.y=h.plate.y; h.face.setVisible(true);
      this.tweens.add({targets:h.face,y:h.plate.y-28,duration:120,ease:'Sine.easeOut'});

      this.time.delayedCall(SETTINGS.mole.upTime,()=>{
        if(h.face.visible){
          this.tweens.add({targets:h.face,y:h.plate.y+24,duration:160,onComplete:()=>h.face.setVisible(false)});
        }
      });
    }});

    // timer
    this.time.addEvent({delay:1000,loop:true,callback:()=>{
      this.timeLeft--; this.timerText.setText(this.timeLeft+'s');
      if(this.timeLeft<=0) this.endGame();
    }});

    this.input.keyboard.on('keydown-ESC',()=>this.returnToMenu());
  }

  bumpCombo(){
    if(this.comboTimer){ this.combo = Math.min(this.combo+1, 9); }
    else { this.combo = 1; }
    clearTimeout(this.comboTimer);
    this.comboTimer = setTimeout(()=>{ this.combo=0; hideCombo(); }, 1500);
    // multiplier tiers: 1-2 -> x1, 3-4 -> x2, 5+ -> x3
    return this.combo>=5 ? 3 : this.combo>=3 ? 2 : 1;
  }
  resetCombo(){ this.combo=0; clearTimeout(this.comboTimer); this.comboTimer=null; }

  endGame(){
    this.popEvt?.remove(); this.resetCombo(); hideCombo();
    this.scene.pause(); saveScore('mole',this.score);
    const {width,height}=this.scale;
    const msg=`Time!\nScore: ${this.score}\nClick to return`;
    const box=this.add.rectangle(width/2,height/2,width*.84,170,0x000000,.7);
    const txt=this.add.text(width/2,height/2,msg,{fontSize:'22px',color:'#fff',align:'center'}).setOrigin(.5);
    [box,txt].forEach(el=>el.setInteractive({useHandCursor:true}).on('pointerdown',()=>this.returnToMenu()));
  }
  returnToMenu(){ this.scene.stop(); showMenu(); }
}

/* ------------------------ Catch the Coins (emoji, full fall, combo + sound) ------------------------ */
class CatchScene extends Phaser.Scene{
  constructor(){ super('catch'); this.score=0; this.timeLeft=25; this.rewarded=false; this.combo=0; this.comboTimer=null; }
  create(){
    const {width,height}=this.scale;
    this.cameras.main.setBackgroundColor('#0a0718');
    this.add.text(width/2,28,'üß∫ Catch the Coins',{fontSize:'24px',color:'#fff'}).setOrigin(.5);
    this.scoreText=this.add.text(20,16,'Score: 0',{fontSize:'20px',color:'#8EFF98'});
    this.timerText=this.add.text(width-20,16,this.timeLeft+'s',{fontSize:'20px',color:'#ffd86a'}).setOrigin(1,0);

    makeEmojiTexture(this,'emoji_coin','ü™ô',52);
    makeRectTexture(this,'basketRect',180,26,0xffd86a);

    this.physics.world.setBounds(0,0,width,height);

    this.basket=this.physics.add.image(width/2,height-60,'basketRect').setImmovable(true);
    this.basket.body.allowGravity=false;

    this.coins=this.physics.add.group({allowGravity:true, gravityY: 700});
    this.physics.add.overlap(this.basket,this.coins,(_,coin)=>{
      const mult=this.bumpCombo();
      Sound.pop();
      this.score+=1*mult; this.scoreText.setText('Score: '+this.score); coin.destroy();
      showCombo(mult);
      if(!this.rewarded && this.score>=SETTINGS.rewardThreshold.catch){ this.rewarded=true; toast(this,'üéâ Reward unlocked!'); }
    });

    this.time.addEvent({delay:500,loop:true,callback:()=>{
      const x=Phaser.Math.Between(40,width-40);
      const coin=this.physics.add.image(x,-30,'emoji_coin');
      coin.setBounce(0).setVelocity(0,120).setMaxVelocity(420,1000).setCollideWorldBounds(false);
      this.coins.add(coin);
      const flash=this.add.rectangle(x,0,6,30,0xffffff).setAlpha(.7);
      this.tweens.add({targets:flash,alpha:0,y:60,duration:350,onComplete:()=>flash.destroy()});
    }});

    this.events.on('update',()=>this.coins.children.iterate(c=>{ if(c&&c.y>height+60)c.destroy(); }));

    this.input.on('pointermove',p=>{ this.basket.x=Phaser.Math.Clamp(p.x,90,width-90); this.basket.body.updateFromGameObject(); });
    this.time.addEvent({delay:1000,loop:true,callback:()=>{ this.timeLeft--; this.timerText.setText(this.timeLeft+'s'); if(this.timeLeft<=0)this.endGame(); }});
    this.input.keyboard.on('keydown-ESC',()=>this.returnToMenu());
  }

  bumpCombo(){
    if(this.comboTimer){ this.combo=Math.min(this.combo+1,9); } else { this.combo=1; }
    clearTimeout(this.comboTimer);
    this.comboTimer=setTimeout(()=>{ this.combo=0; hideCombo(); },1500);
    return this.combo>=5 ? 3 : this.combo>=3 ? 2 : 1;
  }
  endGame(){
    this.combo=0; hideCombo();
    this.scene.pause(); saveScore('catch',this.score);
    const {width,height}=this.scale;
    const msg=`Time!\nScore: ${this.score}\nClick to return`;
    const box=this.add.rectangle(width/2,height/2,width*.84,170,0x000000,.7);
    const txt=this.add.text(width/2,height/2,msg,{fontSize:'22px',color:'#fff',align:'center'}).setOrigin(.5);
    [box,txt].forEach(el=>el.setInteractive({useHandCursor:true}).on('pointerdown',()=>this.returnToMenu()));
  }
  returnToMenu(){ this.scene.stop(); showMenu(); }
}

/* ------------------------ Spin the Wheel (sounds added) ------------------------ */
class WheelScene extends Phaser.Scene{
  constructor(){ super('wheel'); this.spinning=false; }
  create(){
    const {width,height}=this.scale;
    this.cameras.main.setBackgroundColor('#0a0718');
    this.add.text(width/2,28,'üé° Spin the Wheel',{fontSize:'24px',color:'#fff'}).setOrigin(.5);
    this.limitText=this.add.text(width/2,56,'',{fontSize:'16px',color:'#a9b7d8'}).setOrigin(.5);
    this.updateLimitText();

    const radius=Math.min(width,height)*.28;
    const prizes=['+10','+20','+30','+50','Try again','x2','+15','Jackpot'];
    const seg=(Math.PI*2)/prizes.length;

    const g=this.add.graphics({x:0,y:0});
    for(let i=0;i<prizes.length;i++){
      g.fillStyle(i%2?0x8a5dff:0x56d0ff,1);
      g.slice(radius+5,radius+5,radius,i*seg,(i+1)*seg,false).fillPath();
    }
    g.lineStyle(6,0xffffff).strokeCircle(radius+5,radius+5,radius);
    const wheelKey='wheelTex'; g.generateTexture(wheelKey,radius*2+10,radius*2+10); g.destroy();

    this.wheel=this.add.image(width/2,height/2,wheelKey).setInteractive({useHandCursor:true});
    this.wheel.on('pointerdown',()=>this.trySpin(prizes));

    prizes.forEach((p,i)=>{
      const ang=i*seg+seg/2-Math.PI/2;
      const x=width/2+Math.cos(ang)*(radius*.65);
      const y=height/2+Math.sin(ang)*(radius*.65);
      this.add.text(x,y,p,{fontSize:'18px',color:'#0a0718'}).setOrigin(.5);
    });
    this.add.triangle(width/2,height/2-radius-18,0,18,18,18,9,0,0xffd86a).setStrokeStyle(2,0xffffff);

    this.input.keyboard.on('keydown-ESC',()=>this.returnToMenu());
  }
  updateLimitText(){
    const left=Math.max(0,SETTINGS.wheelDailyLimit-getSpinCount());
    this.limitText?.setText(`Spins left today: ${left}/${SETTINGS.wheelDailyLimit}`);
  }
  trySpin(prizes){
    if(this.spinning) return;
    const used=getSpinCount(); if(used>=SETTINGS.wheelDailyLimit){ toast(this,'Limit reached. Come back tomorrow!'); return; }
    this.spinning=true; Sound.click();
    const seg=360/prizes.length, target=Phaser.Math.Between(0,prizes.length-1);
    const angle=360*4+(target*seg)+seg/2;
    this.tweens.add({targets:this.wheel,angle,duration:3200,ease:'Cubic.easeOut',
      onComplete:()=>{
        this.spinning=false; incSpinCount(); this.updateLimitText();
        const prize=prizes[target]; toast(this,`You got: ${prize}`); Sound.ding();
        saveScore('wheel',['+10','+15','+20','+30','+50','x2','Jackpot'].indexOf(prize)+1);
      }});
  }
  returnToMenu(){ this.scene.stop(); showMenu(); }
}

/* ------------------------ boot + ui ------------------------ */
const game=new Phaser.Game({
  type:Phaser.AUTO, backgroundColor:'#090a16',
  scale:{mode:Phaser.Scale.RESIZE,autoCenter:Phaser.Scale.CENTER_BOTH,width:W(),height:H()},
  physics:{default:'arcade',arcade:{debug:false}},
  scene:[MoleScene,CatchScene,WheelScene]
});
function start(mode){ hideMenu(); game.scene.start(mode); }

const menu=document.getElementById('menu');
function showMenu(){ hideCombo(); menu.style.display='grid'; }
function hideMenu(){ menu.style.display='none'; }
showMenu();
document.querySelectorAll('#menu [data-mode]').forEach(b=>b.addEventListener('click',()=>start(b.dataset.mode)));

document.getElementById('claim').addEventListener('click',()=>{
  const active=game.scene.getScenes(true)[0]; if(active) toast(active,'Reward claimed!');
});
addEventListener('resize',()=>game.scale.resize(W(),H()));

/* leaderboard overlay */
const lbOverlay=document.getElementById('leaderboardOverlay');
const lbTables=document.getElementById('lbTables');
document.getElementById('openLeaderboard').onclick=()=>{ renderLB('all'); lbOverlay.style.display='grid'; };
document.getElementById('closeLB').onclick=()=>{ lbOverlay.style.display='none'; };
document.getElementById('clearLB').onclick=()=>{ ['mole','catch','wheel'].forEach(g=>localStorage.removeItem(`lb_${g}`)); renderLB('all'); };
document.querySelectorAll('#lbTabs [data-lb]').forEach(b=>b.onclick=()=>renderLB(b.dataset.lb));

function renderLB(which){
  const games=which==='all'?['mole','catch','wheel']:[which];
  lbTables.innerHTML=games.map(g=>{
    const rows=getScores(g);
    const body=rows.length?rows.map((r,i)=>`<tr><td>${i+1}</td><td>${r.score}</td><td class="muted">${new Date(r.ts).toLocaleString()}</td></tr>`).join(''):`<tr><td colspan="3" class="muted">No scores yet</td></tr>`;
    return `<h3 style="margin:14px 0 6px">${g.toUpperCase()}</h3>
      <table><thead><tr><th>#</th><th>Score</th><th>When</th></tr></thead><tbody>${body}</tbody></table>`;
  }).join('');
}
</script>
</body>
</html>
