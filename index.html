<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mini Game Hub</title>
<style>
  :root { color-scheme: dark; }
  html,body{height:100%;margin:0;background:#090a16;color:#eef4ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  #stage{position:fixed;inset:0}
  canvas{display:block;width:100%;height:100%}

  /* overlays & UI */
  #menu{
    position:fixed;inset:0;display:grid;place-items:center;z-index:6;
    background:linear-gradient(180deg,#0a0718 0%, #090a16 100%);
  }
  #leaderboardOverlay,#starter{
    position:fixed;inset:0;display:none;place-items:center;z-index:6;
    background:linear-gradient(180deg,#0a0718 0%, #090a16 100%);
  }
  .card{width:min(560px,92%);background:#0f1226;border:1px solid #243;border-radius:16px;padding:20px;box-shadow:0 20px 60px #0007;text-align:center}
  .grid{display:grid;gap:12px;margin-top:14px}
  .primary{background:#8a5dff;color:#0a0718;font-weight:800;border:0;padding:12px 16px;border-radius:14px;cursor:pointer;font-size:18px}
  .ghost{background:#1b2040;color:#cfe1ff;border:1px solid #2b325d;padding:10px 14px;border-radius:10px;cursor:pointer;font-size:16px}
  .muted{color:#a9b7d8}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px 10px;border-bottom:1px solid #2b325d;text-align:left}

  #hud{position:fixed;right:12px;bottom:12px;background:#0008;backdrop-filter:blur(8px);padding:8px 12px;border-radius:12px;z-index:5}
  #hud button{border:0;border-radius:12px;padding:8px 12px;font-weight:700;cursor:pointer}

  #backGameBtn{position:fixed;left:12px;top:12px;z-index:7;background:#1b2040;color:#cfe1ff;border:1px solid #2b325d;
    padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer;display:none}

  /* Tilt toggle (only for Catch) */
  #tiltBtn{position:fixed;right:12px;top:12px;z-index:7;background:#1b2040;color:#cfe1ff;border:1px solid #2b325d;
    padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer;display:none}

  .chip{position:fixed;left:50%;transform:translateX(-50%);z-index:7;pointer-events:none;
        padding:6px 12px;border-radius:999px;font-weight:800;border:1px solid}
  #combo{top:68px;background:#1b2040;border-color:#2b325d;display:none}
  #mult {top:104px;background:#20351a;border-color:#2b5d33;display:none}

  #errBadge{position:fixed;right:12px;top:12px;background:#4b1010;border:1px solid #7d1b1b;border-radius:10px;padding:8px 12px;display:none;z-index:9}

  /* Starter tilt row (only for Catch) */
  #tiltRow{display:none;margin-top:6px;gap:10px;align-items:center;justify-content:center}
  #tiltRow label{display:inline-flex;gap:8px;align-items:center;color:#cfe1ff}
</style>
</head>
<body>
  <canvas id="stage"></canvas>

  <noscript>
    <div style="position:fixed;inset:0;display:grid;place-items:center;background:#090a16;color:#fff;z-index:9999">
      <div style="text-align:center">
        <h2>Mini Game Hub</h2>
        <p>Please enable JavaScript to play.</p>
      </div>
    </div>
  </noscript>

  <!-- HUD -->
  <div id="hud"><button id="claim">Claim reward</button></div>
  <div id="combo" class="chip">Combo √ó2</div>
  <div id="mult"  class="chip">√ó2 active</div>
  <button id="backGameBtn">‚Üê Menu</button>
  <button id="tiltBtn">Tilt: Off</button>
  <div id="errBadge"></div>

  <!-- Menu -->
  <div id="menu">
    <div class="card">
      <h1 style="margin:0 0 6px">Mini Game Hub</h1>
      <p class="muted" style="margin:0 0 16px">Pick a game. Press <b>ESC</b> or ‚Äú‚Üê Menu‚Äù to return here.</p>
      <div class="grid">
        <button class="primary" data-mode="mole">üéØ Whack-a-Mole</button>
        <button class="primary" data-mode="catch">üß∫ Catch the Coins</button>
        <button class="ghost" id="openLeaderboard">üèÜ Leaderboard</button>
      </div>
    </div>
  </div>

  <!-- Starter -->
  <div id="starter">
    <div class="card">
      <h2 id="startTitle" style="margin:0 0 8px">Ready?</h2>
      <p class="muted" id="startHint" style="margin:0 0 10px"></p>

      <!-- Tilt pre-enable (Catch only) -->
      <div id="tiltRow">
        <label><input type="checkbox" id="tiltChk"/> Use tilt to move</label>
        <button class="ghost" id="tiltEnableBtn" title="iPhone needs permission">Enable motion</button>
      </div>

      <div class="grid" style="margin-top:12px">
        <button class="primary" id="startBtn">Start</button>
        <button class="ghost" id="backBtn">Back</button>
      </div>
      <div id="countdown" style="font-size:56px; margin-top:14px; display:none">3</div>
    </div>
  </div>

  <!-- Leaderboard -->
  <div id="leaderboardOverlay">
    <div class="card">
      <h2 style="margin:0 0 6px">üèÜ Leaderboard</h2>
      <p class="muted" style="margin:0 0 10px">Top 5 per game (saved on your device)</p>
      <div class="grid" id="lbTabs" style="grid-template-columns:repeat(3,1fr)">
        <button class="ghost" data-lb="mole">Mole</button>
        <button class="ghost" data-lb="catch">Catch</button>
        <button class="ghost" data-lb="all">All</button>
      </div>
      <div id="lbTables" style="margin-top:10px;text-align:left"></div>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:14px">
        <button class="ghost" id="clearLB">Clear my scores</button>
        <button class="primary" id="closeLB">Close</button>
      </div>
    </div>
  </div>

<script>
/* -------- error badge -------- */
(()=>{const b=document.getElementById('errBadge');const show=m=>{b.textContent=m;b.style.display='block';};
addEventListener('error',e=>show(e.message));addEventListener('unhandledrejection',e=>show(String(e.reason)));})();

/* -------- tiny sounds (mobile-friendly) -------- */
const Sound=(()=>{let ctx;
  const ensure=()=>{ if(!ctx) ctx=new (window.AudioContext||window.webkitAudioContext)(); };
  function tone(f,d=0.1,t='sine',v=0.16){ ensure(); const o=ctx.createOscillator(),g=ctx.createGain();
    o.type=t;o.frequency.value=f;o.connect(g);g.connect(ctx.destination);
    const T=ctx.currentTime;g.gain.value=0;g.gain.linearRampToValueAtTime(v,T+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,T+d);o.start(T);o.stop(T+d+0.02);}
  function noise(d=0.2,v=0.25){ ensure(); const n=ctx.sampleRate*d,b=ctx.createBuffer(1,n,ctx.sampleRate),a=b.getChannelData(0);
    for(let i=0;i<n;i++) a[i]=(Math.random()*2-1)*(1-i/n);
    const s=ctx.createBufferSource();s.buffer=b;const g=ctx.createGain();g.gain.value=v;s.connect(g);g.connect(ctx.destination);s.start();}
  // resume on first gesture (iOS)
  const resume=()=>{try{ensure();ctx.resume&&ctx.resume();}catch{}};
  addEventListener('pointerdown',resume,{once:true});
  addEventListener('touchstart',resume,{once:true});
  return{
    pop: ()=>tone(1200,0.06,'triangle',0.18),
    click:()=>tone(640,0.06,'square',0.14),
    ding: ()=>[660,990,1320].forEach((f,i)=>tone(f,0.1-0.02*i,'sine',0.18)),
    boom: ()=>{ noise(0.18,0.28); tone(90,0.18,'sine',0.12); }
  };
})();

/* -------- canvas utils -------- */
const stage=document.getElementById('stage');
const DPR = ()=>window.devicePixelRatio||1;
const W   = ()=>stage.width  = innerWidth*DPR();
const H   = ()=>stage.height = innerHeight*DPR();
const CTX = ()=>stage.getContext('2d');
const isMobile = matchMedia('(pointer: coarse)').matches;

function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }
function roundRect(ctx,x,y,w,h,r,fill,stroke){
  if(w<2*r) r=w/2; if(h<2*r) r=h/2;
  ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath();
  if(fill) ctx.fill(); if(stroke) ctx.stroke();
}

/* -------- HUD chips & toasts -------- */
const comboChip=document.getElementById('combo');
const multChip=document.getElementById('mult');
const showCombo=(m)=>{comboChip.textContent=`Combo √ó${m}`;comboChip.style.display='block';};
const hideCombo=()=>{comboChip.style.display='none';};
const showMult =(s)=>{multChip.textContent=`√ó2 active (${s}s)`;multChip.style.display='block';};
const hideMult =()=>{multChip.style.display='none';};
function toast(msg){
  const t=document.createElement('div');
  Object.assign(t.style,{position:'fixed',left:'50%',top:'85%',transform:'translateX(-50%)',background:'#0008',color:'#fff',padding:'8px 12px',borderRadius:'10px',zIndex:8});
  t.textContent=msg; document.body.appendChild(t);
  setTimeout(()=>{t.style.transition='opacity 1s';t.style.opacity='0';},800);
  setTimeout(()=>t.remove(),1800);
}

/* -------- leaderboard -------- */
function saveScore(game,value){
  try{
    const key=`lb_${game}`; const list=JSON.parse(localStorage.getItem(key)||"[]");
    list.push({score:value,ts:Date.now()}); list.sort((a,b)=>b.score-a.score);
    localStorage.setItem(key,JSON.stringify(list.slice(0,5)));
    const bestKey=`best_${game}`; const best=Math.max(value, +(localStorage.getItem(bestKey)||0));
    localStorage.setItem(bestKey,best);
  }catch(e){}
}
const getScores=(g)=>{try{return JSON.parse(localStorage.getItem(`lb_${g}`)||"[]")}catch(e){return[]}};
const getBest  =(g)=>+localStorage.getItem(`best_${g}`)||0;

/* -------- engine with optional screen shake (used in Catch effects) -------- */
const Engine=(()=>{let raf=0,running=false,last=0,update=null,draw=null,cleanup=null,pointer=null;
  let shakeT=0,shakeAmp=0;
  function loop(ts){
    if(!running) return;
    const dt=Math.min(0.033,(ts-last)/1000); last=ts;
    update&&update(dt);
    const ctx=CTX(); W(); H();
    ctx.save();
    if(shakeT>0){ shakeT-=dt; const a=shakeAmp*(shakeT/0.25); ctx.translate((Math.random()*2-1)*a,(Math.random()*2-1)*a); }
    ctx.clearRect(0,0,stage.width,stage.height);
    draw&&draw(ctx,dt);
    ctx.restore();
    raf=requestAnimationFrame(loop);
  }
  function start(u,d,c,p){ stop(); running=true; update=u; draw=d; cleanup=c||null; pointer=p||null; last=performance.now(); raf=requestAnimationFrame(loop);
    stage.onpointermove=e=>{ const r=stage.getBoundingClientRect(),x=(e.clientX-r.left)*DPR(),y=(e.clientY-r.top)*DPR(); pointer&&pointer('move',x,y); };
    stage.onpointerdown=e=>{ const r=stage.getBoundingClientRect(),x=(e.clientX-r.left)*DPR(),y=(e.clientY-r.top)*DPR(); pointer&&pointer('down',x,y); };
  }
  function stop(){ running=false; cancelAnimationFrame(raf); stage.onpointermove=stage.onpointerdown=null; cleanup&&cleanup(); }
  function shake(dur=0.25,amp=8*DPR()){ shakeT=dur; shakeAmp=amp; if(navigator.vibrate) navigator.vibrate(60); }
  return {start,stop,shake};
})();

/* ================== WHACK-A-MOLE (centered, slower, no shake) ================== */
function playMole(){
  const SPAWN_INTERVAL=0.95, UP_TIME=1.40, HIT_RADIUS=44*DPR(), EMOJI_SIZE=64*DPR(), EMOJI_Y_OFFSET=-6*DPR();
  const s={ timeLeft:25, score:0, grid:[], moles:[], spawnT:0, combo:0, comboTO:null };
  const cols=(Math.min(innerWidth,innerHeight)<720)?3:4, rows=cols;
  const gridW=Math.min(W()*0.9,H()*0.78), cell=gridW/cols;
  const sx=W()/2-gridW/2+cell/2, sy=H()*0.2+cell/2;
  for(let r=0;r<rows;r++) for(let c=0;c<cols;c++) s.grid.push({x:sx+c*cell,y:sy+r*cell});
  const animals=['üêπ','üê±','üê∂','üê∞'];

  function bumpCombo(){ if(s.comboTO){ s.combo=Math.min(s.combo+1,9);} else s.combo=1;
    clearTimeout(s.comboTO); s.comboTO=setTimeout(()=>{s.combo=0;hideCombo();},1500);
    return s.combo>=5?3:s.combo>=3?2:1;}
  function endGame(){ Engine.stop(); clearTimeout(s.comboTO); hideCombo(); saveScore('mole',s.score); toast(`Time! Score: ${s.score}`); showMenu(); }

  function update(dt){
    s.spawnT-=dt;
    if(s.spawnT<=0){
      const free=s.grid.map((_,i)=>i).filter(i=>!s.moles.find(m=>m.idx===i));
      if(free.length){ const idx=free[Math.floor(Math.random()*free.length)];
        s.moles.push({ idx, bomb:Math.random()<0.18, t:UP_TIME });
      }
      s.spawnT=SPAWN_INTERVAL;
    }
    s.moles.forEach(m=>m.t-=dt); s.moles=s.moles.filter(m=>m.t>0);
    s.timeLeft-=dt; if(s.timeLeft<=0) endGame();
  }

  function draw(ctx){
    ctx.save(); ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillStyle='#fff'; ctx.font=`${24*DPR()}px system-ui,sans-serif`; ctx.fillText('üéØ Whack-a-Mole', W()/2, 28*DPR());
    ctx.fillStyle='#8EFF98'; ctx.font=`${20*DPR()}px system-ui,sans-serif`; ctx.fillText(String(Math.round(s.score)), 20*DPR(), 18*DPR());
    ctx.fillStyle='#ffd86a'; ctx.textAlign='right'; ctx.fillText(`${Math.ceil(s.timeLeft)}s`, W()-20*DPR(), 18*DPR());
    const plateW=96*DPR(), plateH=28*DPR(); ctx.strokeStyle='#2b325d'; ctx.lineWidth=2*DPR(); ctx.fillStyle='#1b2040';
    for(const g of s.grid) roundRect(ctx,g.x-plateW/2,g.y-plateH/2,plateW,plateH,6*DPR(),true,true);
    ctx.textAlign='center'; ctx.textBaseline='middle';
    for(const m of s.moles){ const g=s.grid[m.idx]; ctx.font=`${EMOJI_SIZE}px "Apple Color Emoji","Segoe UI Emoji",system-ui`;
      ctx.fillText(m.bomb?'üí£':animals[(m.idx*7)%animals.length], g.x, g.y+EMOJI_Y_OFFSET); }
    ctx.restore();
  }

  function onPointer(type,x,y){
    if(type!=='down') return;
    for(const m of s.moles){
      const g=s.grid[m.idx], cx=g.x, cy=g.y+EMOJI_Y_OFFSET;
      if(Math.hypot(x-cx,y-cy)<=HIT_RADIUS){
        if(m.bomb){ Sound.click(); s.score=Math.max(0,s.score-2); s.combo=0; hideCombo(); }
        else{ const mult=bumpCombo(); Sound.pop(); s.score+=mult; showCombo(mult); }
        s.moles=s.moles.filter(mm=>mm!==m); break;
      }
    }
  }
  Engine.start(update,draw,()=>{ clearTimeout(s.comboTO); },onPointer);
}

/* ======================= CATCH THE COINS (drag + tilt) ======================= */
/* ---- Tilt control (Android + iPhone with permission) ---- */
const tiltBtn=document.getElementById('tiltBtn');
const tiltChk=document.getElementById('tiltChk');
const tiltEnableBtn=document.getElementById('tiltEnableBtn');

let tiltEnabled=false, tiltAvailable=false, tiltSource='orientation';
const tilt={ raw:0, smooth:0 };
let _tiltOnOrientation=null, _tiltOnMotion=null;

function haveMotionAPIs(){ return ('DeviceOrientationEvent' in window) || ('DeviceMotionEvent' in window); }
async function requestMotionPermissionIfNeeded(){
  const DOE=window.DeviceOrientationEvent, DME=window.DeviceMotionEvent;
  if (DOE && typeof DOE.requestPermission==='function') {
    try{ return (await DOE.requestPermission())==='granted'; }catch{return false;}
  }
  if (DME && typeof DME.requestPermission==='function') {
    try{ return (await DME.requestPermission())==='granted'; }catch{return false;}
  }
  return true;
}
function enableTiltListeners(){
  tiltAvailable=false;
  if ('DeviceOrientationEvent' in window) {
    tiltSource='orientation';
    _tiltOnOrientation=(e)=>{
      if(e.gamma==null) return;
      let g=e.gamma; const dead=1.2; if(Math.abs(g)<dead) g=0;
      g=Math.max(-45,Math.min(45,g)); tilt.raw=g/45; // -1..1
    };
    window.addEventListener('deviceorientation',_tiltOnOrientation);
    tiltAvailable=true; return;
  }
  if ('DeviceMotionEvent' in window) {
    tiltSource='motion';
    _tiltOnMotion=(e)=>{
      const ax=e.accelerationIncludingGravity?.x; if(ax==null) return;
      const v=Math.max(-7,Math.min(7,-ax)); tilt.raw=(Math.abs(v)<0.2)?0:(v/7);
    };
    window.addEventListener('devicemotion',_tiltOnMotion);
    tiltAvailable=true;
  }
}
function disableTiltListeners(){
  if(_tiltOnOrientation){ window.removeEventListener('deviceorientation',_tiltOnOrientation); _tiltOnOrientation=null; }
  if(_tiltOnMotion){ window.removeEventListener('devicemotion',_tiltOnMotion); _tiltOnMotion=null; }
  tiltAvailable=false; tilt.raw=0; tilt.smooth=0;
}
async function tryEnableTiltFromStarter(){
  if(!haveMotionAPIs()){ toast('Tilt not supported on this device'); tiltChk.checked=false; return; }
  const ok=await requestMotionPermissionIfNeeded();
  if(!ok){ toast('Motion permission denied'); tiltChk.checked=false; return; }
  enableTiltListeners(); tiltEnabled=true; tiltBtn.textContent='Tilt: On'; tiltChk.checked=true;
}
async function toggleTilt(){
  if(!haveMotionAPIs()){ toast('Tilt not supported on this device'); return; }
  if(!tiltEnabled){ await tryEnableTiltFromStarter(); }
  else{ tiltEnabled=false; tiltBtn.textContent='Tilt: Off'; tiltChk.checked=false; disableTiltListeners(); }
}
tiltBtn.onclick = toggleTilt;
tiltEnableBtn && (tiltEnableBtn.onclick = tryEnableTiltFromStarter);

/* Game */
function playCatch(){
  const basketW = (isMobile ? 140 : 180)*DPR(); // smaller on mobile
  const s={
    timeLeft:25, score:0, items:[], spawnT:0.60, basketX:W()/2, mult:1, multLeft:0,
    combo:0, comboTO:null, particles:[], floaters:[]
  };
  const ground=H()-60*DPR();

  // helpers
  const addFloater=(x,y,text,color='#8EFF98')=>s.floaters.push({x,y,vy:-22*DPR(),life:0.9,text,color});
  const addRing=(x,y)=>s.particles.push({x,y,r:4*DPR(),vr:120*DPR(),life:0.18});
  function bumpCombo(){ if(s.comboTO){ s.combo=Math.min(s.combo+1,9);} else s.combo=1;
    clearTimeout(s.comboTO); s.comboTO=setTimeout(()=>{s.combo=0;hideCombo();},1500);
    return s.combo>=5?3:s.combo>=3?2:1;}
  function activateMult(sec){ s.mult=2; s.multLeft=sec; showMult(Math.ceil(s.multLeft)); Sound.ding(); addFloater(s.basketX,ground-34*DPR(),'√ó2','#ffd86a'); }
  function endGame(){ Engine.stop(); clearTimeout(s.comboTO); hideCombo(); hideMult(); saveScore('catch',s.score); toast(`Time! Score: ${s.score}`); showMenu(); }

  function update(dt){
    // Tilt movement (smooth + responsive)
    if(tiltEnabled){
      const SMOOTH=0.25, SPEED=520*DPR();
      tilt.smooth += (tilt.raw - tilt.smooth)*SMOOTH;
      s.basketX += tilt.smooth * SPEED * dt;
      s.basketX = clamp(s.basketX, 90*DPR(), W()-90*DPR());
    }

    // spawn
    s.spawnT-=dt;
    if(s.spawnT<=0){
      const r=Math.random(); let type='coin'; if(r<0.14) type='bomb'; else if(r>0.84) type='mult';
      s.items.push({x:Math.random()*(W()-80*DPR())+40*DPR(), y:-30*DPR(), vy:120*DPR(), type});
      s.spawnT=0.60;
    }
    // physics
    s.items.forEach(it=>{ it.vy=Math.min(it.vy+700*DPR()*dt,1100*DPR()); it.y+=it.vy*dt; });
    s.items=s.items.filter(i=>i.y<H()+60*DPR());

    // collisions
    const bh=26*DPR(), by=ground;
    s.items=s.items.filter(it=>{
      if(it.y>by-bh && it.x>s.basketX-basketW/2 && it.x<s.basketX+basketW/2){
        if(it.type==='coin'){
          const mult=bumpCombo()*s.mult; Sound.pop(); s.score+=mult; showCombo(mult);
          addFloater(s.basketX,by-34*DPR(),`+${mult}`); addRing(s.basketX,by-10*DPR());
        }else if(it.type==='bomb'){
          Engine.shake(); Sound.boom(); s.score=Math.max(0,s.score-3); s.combo=0; hideCombo();
          addFloater(s.basketX,by-34*DPR(),'-3','#ff9aa4'); addRing(s.basketX,by-10*DPR());
        }else{
          activateMult(6);
        }
        return false;
      }
      return true;
    });

    // particles & floaters
    s.particles.forEach(p=>{ p.life-=dt; p.r+=p.vr*dt; });
    s.particles=s.particles.filter(p=>p.life>0);
    s.floaters.forEach(f=>{ f.life-=dt; f.y+=f.vy*dt; });
    s.floaters=s.floaters.filter(f=>f.life>0);

    // timers
    s.timeLeft-=dt; if(s.timeLeft<=0) endGame();
    if(s.mult>1){ s.multLeft-=dt; if(s.multLeft>0) showMult(Math.ceil(s.multLeft)); else {s.mult=1; hideMult();} }
  }

  function draw(ctx){
    ctx.save(); ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillStyle='#fff'; ctx.font=`${24*DPR()}px system-ui,sans-serif`; ctx.fillText('üß∫ Catch the Coins', W()/2, 28*DPR());
    ctx.fillStyle='#8EFF98'; ctx.font=`${20*DPR()}px system-ui,sans-serif`; ctx.fillText(String(Math.round(s.score)), 20*DPR(), 18*DPR());
    ctx.fillStyle='#ffd86a'; ctx.textAlign='right'; ctx.fillText(`${Math.ceil(s.timeLeft)}s`, W()-20*DPR(), 18*DPR());

    // items
    ctx.textAlign='center'; ctx.textBaseline='middle';
    for(const it of s.items){
      const emoji=it.type==='coin'?'ü™ô':it.type==='bomb'?'üß®':'‚ú®';
      ctx.font=`${52*DPR()}px "Apple Color Emoji","Segoe UI Emoji",system-ui`;
      ctx.fillText(emoji,it.x,it.y);
    }
    // basket
    const bh=26*DPR();
    ctx.fillStyle='#ffd86a'; ctx.strokeStyle='#fff'; ctx.lineWidth=2*DPR();
    roundRect(ctx, s.basketX-basketW/2, ground-bh/2, basketW, bh, 6*DPR(), true, true);

    // rings
    ctx.strokeStyle='rgba(255,216,106,0.6)'; ctx.lineWidth=2*DPR();
    for(const p of s.particles){ ctx.globalAlpha=Math.max(0,p.life); ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.stroke(); }
    ctx.globalAlpha=1;

    // floaters
    for(const f of s.floaters){ ctx.globalAlpha=Math.max(0,f.life); ctx.fillStyle=f.color; ctx.font=`${18*DPR()}px system-ui,sans-serif`; ctx.fillText(f.text,f.x,f.y); }
    ctx.globalAlpha=1; ctx.restore();
  }

  function onPointer(type,x){ if(type==='move') s.basketX=clamp(x,90*DPR(),W()-90*DPR()); }

  Engine.start(update,draw,()=>{
    clearTimeout(s.comboTO);
    if(tiltEnabled){ tiltEnabled=false; tiltBtn.textContent='Tilt: Off'; tiltChk.checked=false; }
    disableTiltListeners(); hideMult(); hideCombo();
  },onPointer);
}

/* ============================ UI wiring ============================ */
const menu=document.getElementById('menu');
const starter=document.getElementById('starter');
const backBtn=document.getElementById('backBtn');
const startBtn=document.getElementById('startBtn');
const startTitle=document.getElementById('startTitle');
const startHint=document.getElementById('startHint');
const cd=document.getElementById('countdown');
const backGameBtn=document.getElementById('backGameBtn');
const lbOverlay=document.getElementById('leaderboardOverlay');
const lbTables=document.getElementById('lbTables');

function showMenu(){
  hideCombo(); hideMult();
  menu.style.display='grid'; starter.style.display='none'; backGameBtn.style.display='none';
  tiltBtn.style.display='none';
  if(tiltEnabled){ tiltEnabled=false; tiltBtn.textContent='Tilt: Off'; tiltChk && (tiltChk.checked=false); }
  disableTiltListeners();
}
function hideMenu(){ menu.style.display='none'; }
function stopAllScenes(){ Engine.stop(); }

let pendingMode=null;
function openStarter(mode){
  pendingMode=mode;
  startTitle.textContent = mode==='mole' ? 'Whack-a-Mole' : 'Catch the Coins';
  startHint.textContent  = mode==='mole'
    ? 'Tap animals to score. Avoid bombs!'
    : 'Move basket to catch ü™ô; avoid üß®; grab ‚ú® for √ó2! You can enable phone tilt below.';
  document.getElementById('tiltRow').style.display = (mode==='catch' && haveMotionAPIs()) ? 'flex' : 'none';
  cd.style.display='none'; starter.style.display='grid';
}
function startScene(mode){
  stopAllScenes();
  backGameBtn.style.display='inline-block';
  if(mode==='mole'){
    tiltBtn.style.display='none';
    playMole();
  }else{
    tiltBtn.style.display = haveMotionAPIs() ? 'inline-block' : 'none';
    tiltBtn.textContent = tiltEnabled ? 'Tilt: On' : 'Tilt: Off';
    playCatch();
  }
}

startBtn.onclick=async()=>{ 
  Sound.click(); cd.style.display='block'; let n=3; cd.textContent=n;
  if (tiltChk && tiltChk.checked && !tiltEnabled) await tryEnableTiltFromStarter();
  const tick=()=>{ n--; if(n>0){ cd.textContent=n; setTimeout(tick,700); } else { starter.style.display='none'; startScene(pendingMode); } };
  setTimeout(tick,700);
};
backBtn.onclick=()=>{ Sound.click(); starter.style.display='none'; showMenu(); };
document.querySelectorAll('#menu [data-mode]').forEach(b=>b.addEventListener('click',()=>{ hideMenu(); openStarter(b.dataset.mode); }));
backGameBtn.onclick=()=>{ Sound.click(); stopAllScenes(); showMenu(); };
addEventListener('keydown',e=>{ if(e.key==='Escape'){ stopAllScenes(); showMenu(); }});

/* leaderboard overlay */
document.getElementById('openLeaderboard').onclick=()=>{ renderLB('all'); lbOverlay.style.display='grid'; };
document.getElementById('closeLB').onclick=()=>{ lbOverlay.style.display='none'; };
document.getElementById('clearLB').onclick=()=>{ ['mole','catch'].forEach(g=>{localStorage.removeItem(`lb_${g}`);localStorage.removeItem(`best_${g}`)}); renderLB('all'); };
document.querySelectorAll('#lbTabs [data-lb]').forEach(b=>b.onclick=()=>renderLB(b.dataset.lb));
function renderLB(which){
  const games=which==='all'?['mole','catch']:[which];
  lbTables.innerHTML=games.map(g=>{
    const rows=getScores(g), best=getBest(g);
    const body=rows.length?rows.map((r,i)=>`<tr><td>${i+1}</td><td>${r.score}</td><td class="muted">${new Date(r.ts).toLocaleString()}</td></tr>`).join('')
                          :`<tr><td colspan="3" class="muted">No scores yet</td></tr>`;
    return `<h3 style="margin:14px 0 6px">${g.toUpperCase()} ‚Äî Best: ${best}</h3>
            <table><thead><tr><th>#</th><th>Score</th><th>When</th></tr></thead><tbody>${body}</tbody></table>`;
  }).join('');
}

/* claim */
document.getElementById('claim').onclick=()=>toast('Reward claimed!');

/* -------- robust boot -------- */
function layout(){ W(); H(); }
window.addEventListener('resize', layout, { passive:true });

window.addEventListener('DOMContentLoaded', () => {
  try {
    layout();
    showMenu();  // force menu visible on boot
  } catch (e) {
    // if anything goes wrong, still show the menu and show error badge
    document.getElementById('menu').style.display = 'grid';
    const badge = document.getElementById('errBadge');
    if (badge) { badge.textContent = e.message || String(e); badge.style.display = 'block'; }
  }
});
</script>
</body>
</html>
