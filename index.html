<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mini Game Hub</title>
<style>
  :root { color-scheme: dark; }
  html,body{height:100%;margin:0;background:#090a16;color:#eef4ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  #stage{position:fixed;inset:0}
  canvas{display:block;width:100%;height:100%}

  #menu,#leaderboardOverlay,#starter{position:fixed;inset:0;display:none;place-items:center;z-index:6;background:linear-gradient(180deg,#0a0718 0%, #090a16 100%)}
  .card{width:min(560px,92%);background:#0f1226;border:1px solid #243;border-radius:16px;padding:20px;box-shadow:0 20px 60px #0007;text-align:center}
  .grid{display:grid;gap:12px;margin-top:14px}
  .primary{background:#8a5dff;color:#0a0718;font-weight:800;border:0;padding:12px 16px;border-radius:14px;cursor:pointer;font-size:18px}
  .ghost{background:#1b2040;color:#cfe1ff;border:1px solid #2b325d;padding:10px 14px;border-radius:10px;cursor:pointer;font-size:16px}
  .muted{color:#a9b7d8}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px 10px;border-bottom:1px solid #2b325d;text-align:left}

  #hud{position:fixed;right:12px;bottom:12px;background:#0008;backdrop-filter:blur(8px);padding:8px 12px;border-radius:12px;z-index:5}
  #hud button{border:0;border-radius:12px;padding:8px 12px;font-weight:700;cursor:pointer}

  #backGameBtn{position:fixed;left:12px;top:12px;z-index:7;background:#1b2040;color:#cfe1ff;border:1px solid #2b325d;
    padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer;display:none}

  .chip{position:fixed;left:50%;transform:translateX(-50%);z-index:7;pointer-events:none;
        padding:6px 12px;border-radius:999px;font-weight:800;border:1px solid}
  #combo{top:68px;background:#1b2040;border-color:#2b325d;display:none}
  #mult {top:104px;background:#20351a;border-color:#2b5d33;display:none}

  #errBadge{position:fixed;right:12px;top:12px;background:#4b1010;border:1px solid #7d1b1b;border-radius:10px;padding:8px 12px;display:none;z-index:9}
</style>
</head>
<body>
  <canvas id="stage"></canvas>

  <div id="hud"><button id="claim">Claim reward</button></div>
  <div id="combo" class="chip">Combo √ó2</div>
  <div id="mult"  class="chip">√ó2 active</div>
  <button id="backGameBtn">‚Üê Menu</button>
  <div id="errBadge"></div>

  <div id="menu">
    <div class="card">
      <h1 style="margin:0 0 6px">Mini Game Hub</h1>
      <p class="muted" style="margin:0 0 16px">Pick a game. Press <b>ESC</b> or ‚Äú‚Üê Menu‚Äù to return here.</p>
      <div class="grid">
        <button class="primary" data-mode="mole">üéØ Whack-a-Mole</button>
        <button class="primary" data-mode="catch">üß∫ Catch the Coins</button>
        <button class="ghost" id="openLeaderboard">üèÜ Leaderboard</button>
      </div>
    </div>
  </div>

  <div id="starter">
    <div class="card">
      <h2 id="startTitle" style="margin:0 0 8px">Ready?</h2>
      <p class="muted" id="startHint" style="margin:0 0 14px"></p>
      <div class="grid">
        <button class="primary" id="startBtn">Start</button>
        <button class="ghost" id="backBtn">Back</button>
      </div>
      <div id="countdown" style="font-size:56px; margin-top:14px; display:none">3</div>
    </div>
  </div>

  <div id="leaderboardOverlay">
    <div class="card">
      <h2 style="margin:0 0 6px">üèÜ Leaderboard</h2>
      <p class="muted" style="margin:0 0 10px">Top 5 per game (saved on your device)</p>
      <div class="grid" id="lbTabs" style="grid-template-columns:repeat(3,1fr)">
        <button class="ghost" data-lb="mole">Mole</button>
        <button class="ghost" data-lb="catch">Catch</button>
        <button class="ghost" data-lb="all">All</button>
      </div>
      <div id="lbTables" style="margin-top:10px;text-align:left"></div>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:14px">
        <button class="ghost" id="clearLB">Clear my scores</button>
        <button class="primary" id="closeLB">Close</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const badge=document.getElementById('errBadge');
  const show=(m)=>{ badge.textContent=m; badge.style.display='block'; };
  addEventListener('error',e=>show(e.message));
  addEventListener('unhandledrejection',e=>show(String(e.reason)));
})();

/* tiny sounds */
const Sound=(()=>{let ctx;
  const ensure=()=>{ if(!ctx) ctx=new (window.AudioContext||window.webkitAudioContext)(); };
  function tone(f,d=0.12,t='sine',v=0.18){ ensure(); const o=ctx.createOscillator(),g=ctx.createGain();
    o.type=t;o.frequency.value=f;o.connect(g);g.connect(ctx.destination);
    const T=ctx.currentTime;g.gain.value=0;g.gain.linearRampToValueAtTime(v,T+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,T+d);o.start(T);o.stop(T+d+0.02);}
  function noise(d=0.25,v=0.3){ ensure(); const n=ctx.sampleRate*d,b=ctx.createBuffer(1,n,ctx.sampleRate),a=b.getChannelData(0);
    for(let i=0;i<n;i++) a[i]=(Math.random()*2-1)*(1-i/n); const s=ctx.createBufferSource(); s.buffer=b;
    const g=ctx.createGain();g.gain.value=v;s.connect(g);g.connect(ctx.destination);s.start();}
  addEventListener('pointerdown',()=>ensure(),{once:true});
  return{pop:()=>tone(1200,0.08,'triangle',0.16),click:()=>tone(880,0.05,'square',0.1),
         ding:()=>[660,990,1320].forEach((f,i)=>tone(f,0.12-0.02*i,'sine',0.16)),
         boom:()=>{noise(0.22,0.35);tone(90,0.2,'sine',0.12);} };
})();

/* canvas utils */
const stage=document.getElementById('stage');
const DPR=()=>window.devicePixelRatio||1;
const W =()=>stage.width = innerWidth*DPR();
const H =()=>stage.height= innerHeight*DPR();
const CTX=()=>stage.getContext('2d');

function between(a,b){ return a*DPR() + Math.random()*(b*DPR()-a*DPR()); }
function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }
function roundRect(ctx,x,y,w,h,r,fill,stroke){
  if(w<2*r) r=w/2; if(h<2*r) r=h/2;
  ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath();
  if(fill) ctx.fill(); if(stroke) ctx.stroke();
}

/* HUD chips */
const comboChip=document.getElementById('combo');
const multChip =document.getElementById('mult');
const showCombo=(m)=>{comboChip.textContent=`Combo √ó${m}`;comboChip.style.display='block';};
const hideCombo=()=>{comboChip.style.display='none';};
const showMult =(s)=>{multChip.textContent=`√ó2 active (${s}s)`;multChip.style.display='block';};
const hideMult =()=>{multChip.style.display='none';};
function toast(msg){
  const t=document.createElement('div');
  Object.assign(t.style,{position:'fixed',left:'50%',top:'85%',transform:'translateX(-50%)',background:'#0008',color:'#fff',padding:'8px 12px',borderRadius:'10px',zIndex:8});
  t.textContent=msg; document.body.appendChild(t);
  setTimeout(()=>{t.style.transition='opacity 1s';t.style.opacity='0';},800);
  setTimeout(()=>t.remove(),1800);
}

/* leaderboard */
function saveScore(game,value){
  try{
    const key=`lb_${game}`; const list=JSON.parse(localStorage.getItem(key)||"[]");
    list.push({score:value,ts:Date.now()}); list.sort((a,b)=>b.score-a.score);
    localStorage.setItem(key,JSON.stringify(list.slice(0,5)));
    const bestKey=`best_${game}`; const best=Math.max(value, +(localStorage.getItem(bestKey)||0));
    localStorage.setItem(bestKey,best);
  }catch(e){}
}
const getScores=(g)=>{try{return JSON.parse(localStorage.getItem(`lb_${g}`)||"[]")}catch(e){return[]}};
const getBest  =(g)=>+localStorage.getItem(`best_${g}`)||0;

/* ---------- tiny engine with SHAKE ---------- */
const Engine=(()=>{let raf=0,running=false,last=0,update=null,draw=null,cleanup=null,pointer=null;
  let shakeT=0,shakeAmp=0,shakes=[];
  function loop(ts){
    if(!running) return;
    const dt=Math.min(0.033,(ts-last)/1000); last=ts;
    update&&update(dt);
    const ctx=CTX(); W(); H();
    ctx.save();
    if(shakeT>0){ // screen shake
      shakeT-=dt; const a=shakeAmp*(shakeT>0?1:0);
      ctx.translate((Math.random()*2-1)*a,(Math.random()*2-1)*a);
    }
    ctx.clearRect(0,0,stage.width,stage.height);
    draw&&draw(ctx,dt);
    ctx.restore();
    raf=requestAnimationFrame(loop);
  }
  function start(u,d,c,p){ stop(); running=true; update=u; draw=d; cleanup=c||null; pointer=p||null; last=performance.now(); raf=requestAnimationFrame(loop);
    stage.onpointermove=e=>{ const r=stage.getBoundingClientRect(),x=(e.clientX-r.left)*DPR(),y=(e.clientY-r.top)*DPR(); pointer&&pointer('move',x,y); };
    stage.onpointerdown=e=>{ const r=stage.getBoundingClientRect(),x=(e.clientX-r.left)*DPR(),y=(e.clientY-r.top)*DPR(); pointer&&pointer('down',x,y); };
  }
  function stop(){ running=false; cancelAnimationFrame(raf); stage.onpointermove=stage.onpointerdown=null; cleanup&&cleanup(); }
  function shake(duration=0.25,amp=6*DPR()){ shakeT=duration; shakeAmp=amp; if(navigator.vibrate) navigator.vibrate(70); }
  return {start,stop,shake};
})();

function playMole(){
  // slower pace
  const SPAWN_INTERVAL = 0.95;   // was 0.62 (slower spawn)
  const UP_TIME        = 1.40;    // was 0.78 (stays up longer)
  const HIT_RADIUS     = 44*DPR(); // bigger, easier to tap
  const EMOJI_SIZE     = 64*DPR();
  const EMOJI_Y_OFFSET = -6*DPR(); // nudge up so it looks visually centered

  const s={ timeLeft:25, score:0, grid:[], moles:[], spawnT:0, combo:0, comboTO:null };
  const cols=(Math.min(innerWidth,innerHeight)<720)?3:4, rows=cols;
  const gridW=Math.min(W()*0.9,H()*0.78), cell=gridW/cols;
  const sx=W()/2-gridW/2+cell/2, sy=H()*0.2+cell/2;

  for(let r=0;r<rows;r++) for(let c=0;c<cols;c++) s.grid.push({x:sx+c*cell,y:sy+r*cell});
  const animals=['üêπ','üê±','üê∂','üê∞'];

  function bumpCombo(){
    if(s.comboTO){ s.combo=Math.min(s.combo+1,9); } else s.combo=1;
    clearTimeout(s.comboTO);
    s.comboTO=setTimeout(()=>{ s.combo=0; hideCombo(); },1500);
    return s.combo>=5?3:s.combo>=3?2:1;
  }
  function endGame(){
    Engine.stop(); clearTimeout(s.comboTO); hideCombo();
    saveScore('mole',s.score);
    toast(`Time! Score: ${s.score}`);
    showMenu();
  }

  function update(dt){
    // spawn
    s.spawnT-=dt;
    if(s.spawnT<=0){
      const freeIdx=s.grid.map((_,i)=>i).filter(i=>!s.moles.find(m=>m.idx===i));
      if(freeIdx.length){
        const idx=freeIdx[Math.floor(Math.random()*freeIdx.length)];
        s.moles.push({ idx, bomb:Math.random()<0.18, t:UP_TIME });
      }
      s.spawnT = SPAWN_INTERVAL;
    }
    // countdown & cull
    s.moles.forEach(m=>m.t-=dt);
    s.moles = s.moles.filter(m=>m.t>0);

    s.timeLeft-=dt;
    if(s.timeLeft<=0) endGame();
  }

  function draw(ctx){
    ctx.save();
    ctx.textAlign='center'; ctx.textBaseline='middle';

    // title & HUD
    ctx.fillStyle='#fff'; ctx.font=`${24*DPR()}px system-ui,sans-serif`;
    ctx.fillText('üéØ Whack-a-Mole', W()/2, 28*DPR());
    ctx.fillStyle='#8EFF98'; ctx.font=`${20*DPR()}px system-ui,sans-serif`;
    ctx.fillText(String(Math.round(s.score)), 20*DPR(), 18*DPR());
    ctx.fillStyle='#ffd86a'; ctx.textAlign='right';
    ctx.fillText(`${Math.ceil(s.timeLeft)}s`, W()-20*DPR(), 18*DPR());

    // holes
    const plateW=96*DPR(), plateH=28*DPR();
    ctx.strokeStyle='#2b325d'; ctx.lineWidth=2*DPR(); ctx.fillStyle='#1b2040';
    for(const g of s.grid){
      roundRect(ctx, g.x-plateW/2, g.y-plateH/2, plateW, plateH, 6*DPR(), true, true);
    }

    // animals ‚Äî perfectly centered (with a tiny Y compensation)
    ctx.textAlign='center'; ctx.textBaseline='middle';
    for(const m of s.moles){
      const g=s.grid[m.idx];
      ctx.font=`${EMOJI_SIZE}px "Apple Color Emoji","Segoe UI Emoji",system-ui`;
      ctx.fillText(m.bomb?'üí£':animals[(m.idx*7)%animals.length], g.x, g.y + EMOJI_Y_OFFSET);
    }

    ctx.restore();
  }

  function onPointer(type,x,y){
    if(type!=='down') return;
    // only the animal is tappable: circle around the emoji center
    for(const m of s.moles){
      const g=s.grid[m.idx];
      const cx=g.x, cy=g.y + EMOJI_Y_OFFSET;
      if(Math.hypot(x-cx, y-cy) <= HIT_RADIUS){
        if(m.bomb){
          // no shake/effects, just sound + penalty
          Sound.boom();
          s.score=Math.max(0,s.score-2);
          s.combo=0; hideCombo();
        }else{
          const mult=bumpCombo();
          Sound.pop();
          s.score += mult; showCombo(mult);
        }
        s.moles = s.moles.filter(mm=>mm!==m);
        break;
      }
    }
  }

  Engine.start(update, draw, ()=>{ clearTimeout(s.comboTO); }, onPointer);
}


/* ---------------- Catch the Coins ---------------- */
function playCatch(){
  const s={timeLeft:25,score:0,items:[],spawnT:0.52,basketX:W()/2,mult:1,multLeft:0,combo:0,comboTO:null,floaters:[]};
  const ground=H()-60*DPR();

  const addFloater=(x,y,text,color='#8EFF98')=>s.floaters.push({x,y,vy:-22*DPR(),life:0.9,text,color});
  function bumpCombo(){ if(s.comboTO){ s.combo=Math.min(s.combo+1,9);} else s.combo=1;
    clearTimeout(s.comboTO); s.comboTO=setTimeout(()=>{s.combo=0;hideCombo();},1500);
    return s.combo>=5?3:s.combo>=3?2:1; }
  function activateMult(sec){ s.mult=2; s.multLeft=sec; showMult(Math.ceil(s.multLeft)); addFloater(s.basketX,ground-30*DPR(),'√ó2','#ffd86a'); }
  function endGame(){ Engine.stop(); clearTimeout(s.comboTO); hideCombo(); hideMult(); saveScore('catch',s.score); toast(`Time! Score: ${s.score}`); showMenu(); }

  function update(dt){
    s.spawnT-=dt;
    if(s.spawnT<=0){
      const r=Math.random(); let type='coin'; if(r<0.14) type='bomb'; else if(r>0.84) type='mult';
      s.items.push({x:between(40,innerWidth-40),y:-30*DPR(),vy:120*DPR(),type,scale:1});
      s.spawnT=0.52;
    }
    s.items.forEach(it=>{ it.vy=Math.min(it.vy+750*DPR()*dt,1100*DPR()); it.y+=it.vy*dt; });
    s.items=s.items.filter(i=>i.y<H()+60*DPR());

    const bw=180*DPR(), bh=26*DPR(), by=ground;
    s.items=s.items.filter(it=>{
      if(it.y>by-bh && it.x>s.basketX-bw/2 && it.x<s.basketX+bw/2){
        if(it.type==='coin'){ const mult=bumpCombo()*s.mult; Sound.pop(); s.score+=mult; showCombo(mult); addFloater(s.basketX,by-34*DPR(),`+${mult}`); }
        else if(it.type==='bomb'){ Engine.shake(0.25,8*DPR()); Sound.boom(); s.score=Math.max(0,s.score-3); s.combo=0; hideCombo(); addFloater(s.basketX,by-34*DPR(),'-3','#ff9aa4'); }
        else { Sound.ding(); activateMult(6); }
        return false;
      }
      return true;
    });

    s.timeLeft-=dt; if(s.timeLeft<=0) endGame();

    if(s.mult>1){ s.multLeft-=dt; if(s.multLeft>0) showMult(Math.ceil(s.multLeft)); else {s.mult=1; hideMult();} }

    s.floaters.forEach(f=>{ f.life-=dt; f.y+=f.vy*dt; });
    s.floaters=s.floaters.filter(f=>f.life>0);
  }

  function draw(ctx){
    ctx.save(); ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillStyle='#fff'; ctx.font=`${24*DPR()}px system-ui,sans-serif`; ctx.fillText('üß∫ Catch the Coins', W()/2, 28*DPR());
    ctx.fillStyle='#8EFF98'; ctx.font=`${20*DPR()}px system-ui,sans-serif`; ctx.fillText(String(Math.round(s.score)), 20*DPR(), 18*DPR());
    ctx.fillStyle='#ffd86a'; ctx.textAlign='right'; ctx.fillText(`${Math.ceil(s.timeLeft)}s`, W()-20*DPR(), 18*DPR());

    // items
    ctx.textAlign='center'; ctx.textBaseline='middle';
    for(const it of s.items){
      const emoji = it.type==='coin'?'ü™ô':it.type==='bomb'?'üß®':'‚ú®';
      ctx.font=`${52*DPR()}px "Apple Color Emoji","Segoe UI Emoji",system-ui`;
      ctx.fillText(emoji,it.x,it.y);
    }
    // basket
    const bw=180*DPR(),bh=26*DPR(); ctx.fillStyle='#ffd86a'; ctx.strokeStyle='#fff'; ctx.lineWidth=2*DPR();
    roundRect(ctx,s.basketX-bw/2,ground-bh/2,bw,bh,6*DPR(),true,true);

    // floaters
    for(const f of s.floaters){ ctx.globalAlpha=Math.max(0,f.life); ctx.fillStyle=f.color; ctx.font=`${18*DPR()}px system-ui,sans-serif`; ctx.fillText(f.text,f.x,f.y); }
    ctx.globalAlpha=1; ctx.restore();
  }

  function onPointer(type,x){ if(type==='move') s.basketX=clamp(x,90*DPR(),W()-90*DPR()); }
  Engine.start(update,draw,()=>{ clearTimeout(s.comboTO); },onPointer);
}

/* -------- UI wiring -------- */
const menu=document.getElementById('menu'), starter=document.getElementById('starter'), backBtn=document.getElementById('backBtn');
const startBtn=document.getElementById('startBtn'), startTitle=document.getElementById('startTitle'), startHint=document.getElementById('startHint');
const cd=document.getElementById('countdown'), backGameBtn=document.getElementById('backGameBtn');
const lbOverlay=document.getElementById('leaderboardOverlay'), lbTables=document.getElementById('lbTables');

function showMenu(){ hideCombo(); hideMult(); menu.style.display='grid'; starter.style.display='none'; backGameBtn.style.display='none'; }
function hideMenu(){ menu.style.display='none'; }
function stopAllScenes(){ Engine.stop(); }

let pendingMode=null;
function openStarter(mode){
  pendingMode=mode;
  startTitle.textContent = mode==='mole' ? 'Whack-a-Mole' : 'Catch the Coins';
  startHint.textContent  = mode==='mole' ? 'Tap animals to score. Avoid bombs!' : 'Move basket to catch ü™ô; avoid üß®; grab ‚ú® for √ó2!';
  starter.style.display='grid'; cd.style.display='none';
}
function startScene(mode){ stopAllScenes(); backGameBtn.style.display='inline-block'; if(mode==='mole') playMole(); else playCatch(); }

startBtn.onclick=()=>{ Sound.click(); cd.style.display='block'; let n=3; cd.textContent=n;
  const tick=()=>{ n--; if(n>0){ cd.textContent=n; setTimeout(tick,700); } else { starter.style.display='none'; startScene(pendingMode); } };
  setTimeout(tick,700);
};
backBtn.onclick=()=>{ Sound.click(); starter.style.display='none'; showMenu(); };
document.querySelectorAll('#menu [data-mode]').forEach(b=>b.addEventListener('click',()=>{ hideMenu(); openStarter(b.dataset.mode); }));
backGameBtn.onclick=()=>{ Sound.click(); stopAllScenes(); showMenu(); };
addEventListener('keydown',e=>{ if(e.key==='Escape'){ stopAllScenes(); showMenu(); }});

/* leaderboard overlay */
document.getElementById('openLeaderboard').onclick=()=>{ renderLB('all'); lbOverlay.style.display='grid'; };
document.getElementById('closeLB').onclick=()=>{ lbOverlay.style.display='none'; };
document.getElementById('clearLB').onclick=()=>{ ['mole','catch'].forEach(g=>{localStorage.removeItem(`lb_${g}`);localStorage.removeItem(`best_${g}`)}); renderLB('all'); };
document.querySelectorAll('#lbTabs [data-lb]').forEach(b=>b.onclick=()=>renderLB(b.dataset.lb));
function renderLB(which){
  const games=which==='all'?['mole','catch']:[which];
  lbTables.innerHTML=games.map(g=>{
    const rows=getScores(g), best=getBest(g);
    const body=rows.length?rows.map((r,i)=>`<tr><td>${i+1}</td><td>${r.score}</td><td class="muted">${new Date(r.ts).toLocaleString()}</td></tr>`).join('')
                          :`<tr><td colspan="3" class="muted">No scores yet</td></tr>`;
    return `<h3 style="margin:14px 0 6px">${g.toUpperCase()} ‚Äî Best: ${best}</h3>
            <table><thead><tr><th>#</th><th>Score</th><th>When</th></tr></thead><tbody>${body}</tbody></table>`;
  }).join('');
}

/* claim */
document.getElementById('claim').onclick=()=>toast('Reward claimed!');

/* boot */
function layout(){ W(); H(); }
addEventListener('resize',layout,{passive:true});
layout(); showMenu();
</script>
</body>
</html>
